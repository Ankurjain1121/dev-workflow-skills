#!/usr/bin/env node
/**
 * Export all blueprints to a combined markdown file or standalone HTML.
 * Cross-platform Node.js script (no Pandoc dependency).
 *
 * Usage:
 *   node scripts/export-markdown.js markdown [output-path]
 *   node scripts/export-markdown.js html [output-path]
 */

const fs = require('fs');
const path = require('path');

const BLUEPRINT_DIR = '.framework-blueprints';
const STATE_FILE = path.join(BLUEPRINT_DIR, '00-project-state.json');

function collectMarkdownFiles(dir, files = []) {
  if (!fs.existsSync(dir)) return files;
  const entries = fs.readdirSync(dir, { withFileTypes: true });
  for (const entry of entries) {
    const fullPath = path.join(dir, entry.name);
    if (entry.isDirectory() && entry.name !== 'backups') {
      collectMarkdownFiles(fullPath, files);
    } else if (entry.name.endsWith('.md')) {
      files.push(fullPath);
    }
  }
  return files.sort();
}

function buildCombinedMarkdown() {
  let state = {};
  if (fs.existsSync(STATE_FILE)) {
    state = JSON.parse(fs.readFileSync(STATE_FILE, 'utf8'));
  }

  const files = collectMarkdownFiles(BLUEPRINT_DIR);
  const date = new Date().toISOString().split('T')[0];

  let output = `# ${state.projectName || 'Project'} - Framework Blueprint\n\n`;
  output += `**Generated:** ${date}\n`;
  output += `**Version:** ${state.version || '1.0.0'}\n`;
  output += `**Current Phase:** ${state.currentPhase || 'N/A'}\n\n`;
  output += `---\n\n`;

  for (const file of files) {
    const relativePath = path.relative(BLUEPRINT_DIR, file);
    const content = fs.readFileSync(file, 'utf8');
    output += `## ${relativePath}\n\n`;
    output += content;
    output += '\n\n---\n\n';
  }

  return output;
}

function wrapInHtml(markdown, title) {
  // Simple markdown-to-html (headers, bold, code blocks, tables, lists)
  let html = markdown
    .replace(/^### (.+)$/gm, '<h3>$1</h3>')
    .replace(/^## (.+)$/gm, '<h2>$1</h2>')
    .replace(/^# (.+)$/gm, '<h1>$1</h1>')
    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
    .replace(/`([^`]+)`/g, '<code>$1</code>')
    .replace(/^- (.+)$/gm, '<li>$1</li>')
    .replace(/^---$/gm, '<hr>')
    .replace(/\n\n/g, '</p><p>');

  return `<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>${title}</title>
<style>
  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; max-width: 900px; margin: 0 auto; padding: 2rem; line-height: 1.6; color: #1f2937; }
  h1, h2, h3 { color: #4F46E5; }
  h1 { border-bottom: 2px solid #4F46E5; padding-bottom: 0.5rem; }
  pre, code { background: #f3f4f6; padding: 0.2rem 0.4rem; border-radius: 0.25rem; }
  pre { padding: 1rem; overflow-x: auto; }
  table { width: 100%; border-collapse: collapse; margin: 1rem 0; }
  th, td { border: 1px solid #e5e7eb; padding: 0.75rem; text-align: left; }
  th { background: #f9fafb; }
  hr { border: none; border-top: 1px solid #e5e7eb; margin: 2rem 0; }
  @media (prefers-color-scheme: dark) {
    body { background: #1f2937; color: #f3f4f6; }
    pre, code, th { background: #374151; }
    td, th { border-color: #374151; }
  }
</style>
</head>
<body>
<p>${html}</p>
<footer><p><em>Generated by Framework Developer Orchestrator</em></p></footer>
</body>
</html>`;
}

// Main
const format = process.argv[2] || 'markdown';
const outputPath = process.argv[3];

if (!fs.existsSync(BLUEPRINT_DIR)) {
  console.log('No .framework-blueprints/ directory found.');
  process.exit(1);
}

const markdown = buildCombinedMarkdown();
let state = {};
if (fs.existsSync(STATE_FILE)) {
  state = JSON.parse(fs.readFileSync(STATE_FILE, 'utf8'));
}
const projectName = state.projectName || 'project';

if (format === 'html') {
  const html = wrapInHtml(markdown, `${projectName} Blueprint`);
  const outFile = outputPath || `${projectName}-blueprint.html`;
  fs.writeFileSync(outFile, html);
  console.log(`HTML exported: ${outFile}`);
} else {
  const outFile = outputPath || `${projectName}-blueprint.md`;
  fs.writeFileSync(outFile, markdown);
  console.log(`Markdown exported: ${outFile}`);
}
